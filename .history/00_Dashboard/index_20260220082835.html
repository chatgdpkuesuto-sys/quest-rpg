<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Machadun Dashboard (OBS Overlay)</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <!-- üåü NEW: È≠öÁúº„É¨„É≥„Ç∫ÔºàÁêÉÈù¢Ôºâ„Éï„Ç£„É´„Çø„ÉºÂÆöÁæ© üåü -->
    <svg style="position: fixed; width: 0; height: 0;">
        <filter id="fisheye-filter">
            <feTurbulence type="fractalNoise" baseFrequency="0.01" numOctaves="1" result="noise" />
            <feDisplacementMap in="SourceGraphic" in2="noise" scale="0" xChannelSelector="R" yChannelSelector="G"
                id="fisheye-map" />
            <!-- ÁêÉÈù¢Ê≠™„Åø„Çí„Ç∑„É≥„Éó„É´„Å´ÂÜçÁèæ„Åô„Çã„Åü„ÇÅ„Å´ matrix „Å® scale „ÇíÁµÑ„ÅøÂêà„Çè„Åõ„ÇãÔºàÂæå„Åª„Å©JS„ÅßÂà∂Âæ°Ôºâ -->
        </filter>
    </svg>

    <!-- ËÉåÊôØCGÁî®„Ç≥„É≥„ÉÜ„Éä (engine.js „Åß background-image „ÇíÂãïÁöÑ„Å´Âà∂Âæ°) -->
    <div id="bg-container"></div>

    <!-- ÁãÇÊ∞ó„ÉªÁô∫ÊÉÖ„Ç®„Éï„Çß„ÇØ„ÉàÁî®„Ç™„Éº„Éê„Éº„É¨„Ç§ -->
    <div id="blood-overlay"></div>
    <div id="glitch-overlay"></div>

    <!-- Zundamon Voice Player -->
    <audio id="voice-player" src="outputs/voice.wav" preload="none"></audio>
    <!-- Sound Effects Player -->
    <audio id="se-player" preload="none"></audio>

    <!-- üåü NEW: ‰∏âÈÄ£„ÉªËìÑÁ©ç„Ç≤„Éº„Ç∏Ôºà‰∏â„Å§„ÅÆÁô∫Â±ïÔºâ üåü -->
    <div id="buildup-container">
        <!-- ÂóúËôêÔºöÂè≥„ÇØ„É™„ÉÉ„ÇØ -->
        <div class="buildup-bar">
            <div id="fill-lust" class="buildup-fill lust"></div><span class="gauge-label">LUST / CHAOS</span>
        </div>
        <!-- ÁÆ°ÁêÜÔºö‰∏≠„ÇØ„É™„ÉÉ„ÇØ -->
        <div class="buildup-bar">
            <div id="fill-special" class="buildup-fill special"></div><span class="gauge-label">SENSE / OBSERVE</span>
        </div>
        <!-- ÊÖàÊÑõÔºöÂ∑¶„ÇØ„É™„ÉÉ„ÇØ -->
        <div class="buildup-bar">
            <div id="fill-love" class="buildup-fill love"></div><span class="gauge-label">LOVE / CARESS</span>
        </div>
    </div>

    <!-- üåü NEW: „ÇØ„É©„Ç§„Éû„ÉÉ„ÇØ„ÇπÁô∫Âãï„Éú„Çø„É≥ÔºàÊâãÂãïÔºâ üåü -->
    <button id="climax-trigger" onclick="triggerClimax()">CLIMAX!!</button>

    <!-- üåü NEW: „Éû„É≥„Ç¨È¢® Âêπ„ÅçÂá∫„Åó„Ç≥„É≥„ÉÜ„Éä üåü -->
    <div id="bubble-container"></div>

    <script>
        async function sendAction(actionName, x = 0, y = 0) {
            console.log(`Action Sent: ${actionName} at (${x}%, ${y}%)`);

            // Ë¶ñË¶öÁöÑ„Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØÔºà„ÇØ„É™„ÉÉ„ÇØÊôÇÔºâ
            document.body.style.animation = "shake 0.1s";
            setTimeout(() => document.body.style.animation = "none", 100);

            try {
                // URL„Éë„É©„É°„Éº„Çø„Å´„Çø„Ç§„É†„Çπ„Çø„É≥„Éó„Çí„Å§„Åë„Å¶„Ç≠„É£„ÉÉ„Ç∑„É•„ÇíÂÆåÂÖ®„Å´ÁÑ°ÂäπÂåñ„Åô„Çã
                await fetch(`http://localhost:5000/action?t=${Date.now()}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Cache-Control': 'no-cache'
                    },
                    body: JSON.stringify({
                        action: actionName,
                        x: x,
                        y: y,
                        time: Date.now()
                    })
                });
            } catch (e) {
                console.error("Failed to send action:", e);
            }
        }

        // üåü NEW: „ÇØ„É™„ÉÉ„ÇØ„Ç®„Éï„Çß„ÇØ„ÉàÔºàË¶ñË¶öÁöÑ„ÇÆ„Éü„ÉÉ„ÇØÔºâ
        function createClickEffect(x, y, type = 'heart') {
            const effect = document.createElement('div');
            effect.className = 'click-effect';
            effect.style.left = x + '%';
            effect.style.top = y + '%';

            // „Çø„Ç§„Éó„Å´„Çà„Å£„Å¶„Ç¢„Ç§„Ç≥„É≥„ÇíÂ§â„Åà„Çã
            if (type === 'heart') effect.innerHTML = '‚ù§Ô∏è';
            else if (type === 'blue-sparkle') effect.innerHTML = '‚ú®';
            else effect.innerHTML = 'üî•';

            document.body.appendChild(effect);

            // ÂäπÊûúÈü≥„ÅÆÂÜçÁîüÔºà„ÅÇ„ÇãÂ†¥ÂêàÔºâ
            const se = document.getElementById('se-player');
            se.src = 'sounds/hit.mp3';
            se.play().catch(e => console.log("SE Play blocked"));

            setTimeout(() => effect.remove(), 800);
        }

        // üåü NEW: „Éï„É´„Çπ„ÇØ„É™„Éº„É≥„Éª„Éû„Ç¶„Çπ„ÇØ„É™„ÉÉ„ÇØÂà∂Âæ° (Â∫ßÊ®ôÂèñÂæóÁâà) üåü
        document.addEventListener('contextmenu', event => event.preventDefault());

        // üåü NEW: ‰∏âÈÄ£„ÉªËìÑÁ©ç„Ç≤„Éº„Ç∏„ÅÆÁä∂ÊÖãÁÆ°ÁêÜ
        let gauges = {
            love: 0,
            lust: 0,
            special: 0
        };

        // üåü NEW: ÂÜÜÈÅãÂãï„ÉªÈ≠öÁúº„ÅÆÁä∂ÊÖãÁÆ°ÁêÜ
        let time = 0;
        let mirrorScale = 1; // 1 or -1 for instant flip
        let pendingClimax = null; // ËìÑÁ©ç„Åï„Çå„Åü„Ç≥„Éû„É≥„Éâ„Çí‰∏ÄÊôÇ‰øùÊåÅ

        function triggerClimax() {
            if (!pendingClimax) return;

            console.log("üöÄ TRIGGERING MANUAL CLIMAX!");

            // 1. AI„Å∏ÈÄÅ‰ø°
            sendAction(pendingClimax.action, pendingClimax.x, pendingClimax.y);

            // 2. Á´ã„Å°ÁµµÂàá„ÇäÊõø„Åà
            if (typeof cycleVariant === "function") cycleVariant();

            // 3. UI„É™„Çª„ÉÉ„Éà
            const btn = document.getElementById('climax-trigger');
            btn.style.display = 'none';
            for (let k in gauges) gauges[k] = 0;
            document.querySelectorAll('.buildup-fill').forEach(el => el.style.width = '0%');

            pendingClimax = null;
        }

        function updateVisuals() {
            time += 0.05;
            const bg = document.getElementById('bg-container');
            const map = document.getElementById('fisheye-map');

            // „Ç≤„Éº„Ç∏„ÅÆÂπ≥ÂùáÂÄ§„ÇíË®àÁÆóÔºà0.0 ~ 1.0Ôºâ
            const avgGauge = (gauges.love + gauges.lust + gauges.special) / 300;

            // 1. ÂÜÜÈÅãÂãï (Radius and speed scale with gauge - Visual Overdrive)
            const speed = 0.05 + (avgGauge * 0.3); // ÈÄüÂ∫¶„Ç¢„ÉÉ„Éó
            time += speed;
            const radius = 10 + (avgGauge * 100); // 10px ~ 110px (ÊøÄ„Åó„ÅèÔºÅ)
            const x = Math.cos(time) * radius;
            const y = Math.sin(time) * radius;

            // 2. È≠öÁúºÊ≠™„Åø„ÅÆÂº∑„Åï (Scales with gauge - Overdrive)
            if (map) map.setAttribute('scale', avgGauge * 120); // 0 ~ 120 (ÂÄçÂä†)

            // 3. 3DÂõûËª¢„Å®ÁßªÂãï„ÅÆÈÅ©Áî® (ScaleX for instant mirror)
            bg.style.transform = `scaleX(${mirrorScale}) translate(${x}px, ${y}px) scale(${1.1 + avgGauge * 0.2})`;

            requestAnimationFrame(updateVisuals);
        }
        updateVisuals();

        // üåü „Ç≤„Éº„Ç∏„ÅÆËá™ÂãïÊ∏õÂ∞ëÔºàDecayÔºâ„É≠„Ç∏„ÉÉ„ÇØ
        setInterval(() => {
            for (let key in gauges) {
                if (gauges[key] > 0) {
                    gauges[key] -= 0.3; // „ÇÜ„Å£„Åè„ÇäÊàª„ÇãÔºàÁßíÈñìÁ¥Ñ3%Ê∏õÂ∞ëÔºâ
                    if (gauges[key] < 0) gauges[key] = 0;
                    const fill = document.getElementById(`fill-${key}`);
                    if (fill) fill.style.width = gauges[key] + '%';
                }
            }
        }, 100);

        document.addEventListener('mousedown', (event) => {
            if (event.target.id === 'init-audio') return;

            const xPercent = Math.round((event.clientX / window.innerWidth) * 100);
            const yPercent = Math.round((event.clientY / window.innerHeight) * 100);

            let clickType = 'heart';
            let gaugeKey = 'love';
            let actionIntent = "Â∑¶„ÇØ„É™„ÉÉ„ÇØÔºàËÇØÂÆöÔºèÊÑõÊí´Ôºâ";

            if (event.button === 2) {
                clickType = 'fire';
                gaugeKey = 'lust';
                actionIntent = "Âè≥„ÇØ„É™„ÉÉ„ÇØÔºàÂóúËôêÔºè„Éè„Éó„Éã„É≥„Ç∞Ôºâ";
            } else if (event.button === 1) {
                clickType = 'blue-sparkle';
                gaugeKey = 'special';
                actionIntent = "„Éõ„Ç§„Éº„É´„ÇØ„É™„ÉÉ„ÇØÔºàÁâπÊÆäË°åÂãïÔºèË¶≥ÂØüÔºâ";
            }

            // 1. „Ç≤„Éº„Ç∏„ÅÆËìÑÁ©ç (+15% per click, Ê∏õÂ∞ë„Åå„ÅÇ„Çã„Åü„ÇÅÂ∞ë„ÅóÂ§ö„ÇÅ„Å´Ë®≠ÂÆö)
            gauges[gaugeKey] += 15;
            if (gauges[gaugeKey] > 100) gauges[gaugeKey] = 100;

            // 2. „Ç≤„Éº„Ç∏„ÅÆË¶ñË¶öÁöÑÊõ¥Êñ∞
            document.getElementById(`fill-${gaugeKey}`).style.width = gauges[gaugeKey] + '%';

            // 3. „Ç®„Éï„Çß„ÇØ„Éà„ÅÆË°®Á§∫„ÅÆ„ÅøÔºàÂèçËª¢„ÅØ„Åì„Åì„Åß„ÅØË°å„Çè„Å™„ÅÑÔºâ
            createClickEffect(xPercent, yPercent, clickType);

            // 4. „Ç≤„Éº„Ç∏„Åå100%„Å´„Å™„Å£„Åü„Çâ„ÄåÁô∫Â±ï„Éú„Çø„É≥„Äç„ÇíË°®Á§∫ÔºÅ
            if (gauges[gaugeKey] >= 100) {
                console.log(`üî• ${gaugeKey.toUpperCase()} GAUGE PENDING CLIMAX! üî•`);

                // „É´„Éº„Éà„Å´Âøú„Åò„Åü„ÉâÊ¥æÊâã„Å™ÊºîÂá∫Âêç
                const pathNames = { love: "ÊÖàÊÑõ„ÉªË™øÊïô„É´„Éº„Éà", lust: "Ê∑´Èù°„ÉªÂóúËôê„É´„Éº„Éà", special: "ÁâπÊÆä„ÉªË¶öÈÜí„É´„Éº„Éà" };
                const finalAction = `${pathNames[gaugeKey]} [Ê∑±Ê∑µ„Å∏„ÅÆÁô∫Â±ï]`;

                // „Éú„Çø„É≥„ÅÆË°®Á§∫„Å®Ë®≠ÂÆö
                const btn = document.getElementById('climax-trigger');
                btn.className = gaugeKey; // Ëâ≤Êõø„ÅàÁî®
                btn.innerText = "DEVOUR " + gaugeKey.toUpperCase();
                btn.style.display = 'block';

                // ÂÆüË°åÂæÖ„Å°„Å®„Åó„Å¶‰øùÂ≠ò
                pendingClimax = {
                    action: finalAction,
                    x: xPercent,
                    y: yPercent
                };

                // üåü „Ç§„É©„Çπ„ÉàÂàá„ÇäÊõø„ÅàÊôÇ„Å´„É©„É≥„ÉÄ„É†„ÅßÂ∑¶Âè≥ÂèçËª¢ (50% chance)
                mirrorScale = Math.random() > 0.5 ? 1 : -1;

                // „ÉâÊ¥æÊâã„Å™„Ç®„Éï„Çß„ÇØ„Éà
                for (let i = 0; i < 15; i++) {
                    setTimeout(() => createClickEffect(50 + (Math.random() - 0.5) * 40, 50 + (Math.random() - 0.5) * 40, clickType), i * 40);
                }
            }
        });
    </script>

    <!-- Ë®≠ÂÆö„Éï„Ç°„Ç§„É´Ë™≠Ëæº -->
    <script src="status.js"></script>
    <!-- „Ç®„É≥„Ç∏„É≥„É≠„Ç∏„ÉÉ„ÇØË™≠Ëæº -->
    <script src="engine.js"></script>
</body>

</html>